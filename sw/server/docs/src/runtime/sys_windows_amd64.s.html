<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Source: sys_windows_amd64.s in package runtime</title>
<link href="../../css/auto-v0.7.5.css" rel="stylesheet">
<script src="../../jvs/golds-v0.7.5.js"></script>
<body onload="onPageLoad()"><div>

<pre id="header"><code><span class="title">Source File</span>
	sys_windows_amd64.s

<span class="title">Belonging Package</span>
	<a href="../../pkg/runtime.html">runtime</a>
</code></pre>

<pre class="line-numbers">
<span class="codeline" id="line-1"><code>// Copyright 2011 The Go Authors. All rights reserved.</code></span>
<span class="codeline" id="line-2"><code>// Use of this source code is governed by a BSD-style</code></span>
<span class="codeline" id="line-3"><code>// license that can be found in the LICENSE file.</code></span>
<span class="codeline" id="line-4"><code></code></span>
<span class="codeline" id="line-5"><code>#include "go_asm.h"</code></span>
<span class="codeline" id="line-6"><code>#include "go_tls.h"</code></span>
<span class="codeline" id="line-7"><code>#include "textflag.h"</code></span>
<span class="codeline" id="line-8"><code>#include "time_windows.h"</code></span>
<span class="codeline" id="line-9"><code>#include "cgo/abi_amd64.h"</code></span>
<span class="codeline" id="line-10"><code></code></span>
<span class="codeline" id="line-11"><code>// Offsets into Thread Environment Block (pointer in GS)</code></span>
<span class="codeline" id="line-12"><code>#define TEB_TlsSlots 0x1480</code></span>
<span class="codeline" id="line-13"><code>#define TEB_ArbitraryPtr 0x28</code></span>
<span class="codeline" id="line-14"><code></code></span>
<span class="codeline" id="line-15"><code>TEXT runtime·asmstdcall_trampoline&lt;ABIInternal&gt;(SB),NOSPLIT,$0</code></span>
<span class="codeline" id="line-16"><code>	MOVQ	AX, CX</code></span>
<span class="codeline" id="line-17"><code>	JMP	runtime·asmstdcall(SB)</code></span>
<span class="codeline" id="line-18"><code></code></span>
<span class="codeline" id="line-19"><code>// void runtime·asmstdcall(void *c);</code></span>
<span class="codeline" id="line-20"><code>TEXT runtime·asmstdcall(SB),NOSPLIT,$16</code></span>
<span class="codeline" id="line-21"><code>	MOVQ	SP, AX</code></span>
<span class="codeline" id="line-22"><code>	ANDQ	$~15, SP	// alignment as per Windows requirement</code></span>
<span class="codeline" id="line-23"><code>	MOVQ	AX, 8(SP)</code></span>
<span class="codeline" id="line-24"><code>	MOVQ	CX, 0(SP)	// asmcgocall will put first argument into CX.</code></span>
<span class="codeline" id="line-25"><code></code></span>
<span class="codeline" id="line-26"><code>	MOVQ	libcall_fn(CX), AX</code></span>
<span class="codeline" id="line-27"><code>	MOVQ	libcall_args(CX), SI</code></span>
<span class="codeline" id="line-28"><code>	MOVQ	libcall_n(CX), CX</code></span>
<span class="codeline" id="line-29"><code></code></span>
<span class="codeline" id="line-30"><code>	// SetLastError(0).</code></span>
<span class="codeline" id="line-31"><code>	MOVQ	0x30(GS), DI</code></span>
<span class="codeline" id="line-32"><code>	MOVL	$0, 0x68(DI)</code></span>
<span class="codeline" id="line-33"><code></code></span>
<span class="codeline" id="line-34"><code>	SUBQ	$(const_maxArgs*8), SP	// room for args</code></span>
<span class="codeline" id="line-35"><code></code></span>
<span class="codeline" id="line-36"><code>	// Fast version, do not store args on the stack.</code></span>
<span class="codeline" id="line-37"><code>	CMPL	CX, $0;	JE	_0args</code></span>
<span class="codeline" id="line-38"><code>	CMPL	CX, $1;	JE	_1args</code></span>
<span class="codeline" id="line-39"><code>	CMPL	CX, $2;	JE	_2args</code></span>
<span class="codeline" id="line-40"><code>	CMPL	CX, $3;	JE	_3args</code></span>
<span class="codeline" id="line-41"><code>	CMPL	CX, $4;	JE	_4args</code></span>
<span class="codeline" id="line-42"><code></code></span>
<span class="codeline" id="line-43"><code>	// Check we have enough room for args.</code></span>
<span class="codeline" id="line-44"><code>	CMPL	CX, $const_maxArgs</code></span>
<span class="codeline" id="line-45"><code>	JLE	2(PC)</code></span>
<span class="codeline" id="line-46"><code>	INT	$3			// not enough room -&gt; crash</code></span>
<span class="codeline" id="line-47"><code></code></span>
<span class="codeline" id="line-48"><code>	// Copy args to the stack.</code></span>
<span class="codeline" id="line-49"><code>	MOVQ	SP, DI</code></span>
<span class="codeline" id="line-50"><code>	CLD</code></span>
<span class="codeline" id="line-51"><code>	REP; MOVSQ</code></span>
<span class="codeline" id="line-52"><code>	MOVQ	SP, SI</code></span>
<span class="codeline" id="line-53"><code></code></span>
<span class="codeline" id="line-54"><code>	// Load first 4 args into correspondent registers.</code></span>
<span class="codeline" id="line-55"><code>	// Floating point arguments are passed in the XMM</code></span>
<span class="codeline" id="line-56"><code>	// registers. Set them here in case any of the arguments</code></span>
<span class="codeline" id="line-57"><code>	// are floating point values. For details see</code></span>
<span class="codeline" id="line-58"><code>	//	https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170</code></span>
<span class="codeline" id="line-59"><code>_4args:</code></span>
<span class="codeline" id="line-60"><code>	MOVQ	24(SI), R9</code></span>
<span class="codeline" id="line-61"><code>	MOVQ	R9, X3</code></span>
<span class="codeline" id="line-62"><code>_3args:</code></span>
<span class="codeline" id="line-63"><code>	MOVQ	16(SI), R8</code></span>
<span class="codeline" id="line-64"><code>	MOVQ	R8, X2</code></span>
<span class="codeline" id="line-65"><code>_2args:</code></span>
<span class="codeline" id="line-66"><code>	MOVQ	8(SI), DX</code></span>
<span class="codeline" id="line-67"><code>	MOVQ	DX, X1</code></span>
<span class="codeline" id="line-68"><code>_1args:</code></span>
<span class="codeline" id="line-69"><code>	MOVQ	0(SI), CX</code></span>
<span class="codeline" id="line-70"><code>	MOVQ	CX, X0</code></span>
<span class="codeline" id="line-71"><code>_0args:</code></span>
<span class="codeline" id="line-72"><code></code></span>
<span class="codeline" id="line-73"><code>	// Call stdcall function.</code></span>
<span class="codeline" id="line-74"><code>	CALL	AX</code></span>
<span class="codeline" id="line-75"><code></code></span>
<span class="codeline" id="line-76"><code>	ADDQ	$(const_maxArgs*8), SP</code></span>
<span class="codeline" id="line-77"><code></code></span>
<span class="codeline" id="line-78"><code>	// Return result.</code></span>
<span class="codeline" id="line-79"><code>	MOVQ	0(SP), CX</code></span>
<span class="codeline" id="line-80"><code>	MOVQ	8(SP), SP</code></span>
<span class="codeline" id="line-81"><code>	MOVQ	AX, libcall_r1(CX)</code></span>
<span class="codeline" id="line-82"><code>	// Floating point return values are returned in XMM0. Setting r2 to this</code></span>
<span class="codeline" id="line-83"><code>	// value in case this call returned a floating point value. For details,</code></span>
<span class="codeline" id="line-84"><code>	// see https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention</code></span>
<span class="codeline" id="line-85"><code>	MOVQ    X0, libcall_r2(CX)</code></span>
<span class="codeline" id="line-86"><code></code></span>
<span class="codeline" id="line-87"><code>	// GetLastError().</code></span>
<span class="codeline" id="line-88"><code>	MOVQ	0x30(GS), DI</code></span>
<span class="codeline" id="line-89"><code>	MOVL	0x68(DI), AX</code></span>
<span class="codeline" id="line-90"><code>	MOVQ	AX, libcall_err(CX)</code></span>
<span class="codeline" id="line-91"><code></code></span>
<span class="codeline" id="line-92"><code>	RET</code></span>
<span class="codeline" id="line-93"><code></code></span>
<span class="codeline" id="line-94"><code>// faster get/set last error</code></span>
<span class="codeline" id="line-95"><code>TEXT runtime·getlasterror(SB),NOSPLIT,$0</code></span>
<span class="codeline" id="line-96"><code>	MOVQ	0x30(GS), AX</code></span>
<span class="codeline" id="line-97"><code>	MOVL	0x68(AX), AX</code></span>
<span class="codeline" id="line-98"><code>	MOVL	AX, ret+0(FP)</code></span>
<span class="codeline" id="line-99"><code>	RET</code></span>
<span class="codeline" id="line-100"><code></code></span>
<span class="codeline" id="line-101"><code>// Called by Windows as a Vectored Exception Handler (VEH).</code></span>
<span class="codeline" id="line-102"><code>// CX is pointer to struct containing</code></span>
<span class="codeline" id="line-103"><code>// exception record and context pointers.</code></span>
<span class="codeline" id="line-104"><code>// DX is the kind of sigtramp function.</code></span>
<span class="codeline" id="line-105"><code>// Return value of sigtrampgo is stored in AX.</code></span>
<span class="codeline" id="line-106"><code>TEXT sigtramp&lt;&gt;(SB),NOSPLIT,$0-0</code></span>
<span class="codeline" id="line-107"><code>	// Switch from the host ABI to the Go ABI.</code></span>
<span class="codeline" id="line-108"><code>	PUSH_REGS_HOST_TO_ABI0()</code></span>
<span class="codeline" id="line-109"><code></code></span>
<span class="codeline" id="line-110"><code>	// Set up ABIInternal environment: cleared X15 and R14.</code></span>
<span class="codeline" id="line-111"><code>	// R14 is cleared in case there's a non-zero value in there</code></span>
<span class="codeline" id="line-112"><code>	// if called from a non-go thread.</code></span>
<span class="codeline" id="line-113"><code>	XORPS	X15, X15</code></span>
<span class="codeline" id="line-114"><code>	XORQ	R14, R14</code></span>
<span class="codeline" id="line-115"><code></code></span>
<span class="codeline" id="line-116"><code>	get_tls(AX)</code></span>
<span class="codeline" id="line-117"><code>	CMPQ	AX, $0</code></span>
<span class="codeline" id="line-118"><code>	JE	2(PC)</code></span>
<span class="codeline" id="line-119"><code>	// Exception from Go thread, set R14.</code></span>
<span class="codeline" id="line-120"><code>	MOVQ	g(AX), R14</code></span>
<span class="codeline" id="line-121"><code></code></span>
<span class="codeline" id="line-122"><code>	// Reserve space for spill slots.</code></span>
<span class="codeline" id="line-123"><code>	ADJSP	$16</code></span>
<span class="codeline" id="line-124"><code>	MOVQ	CX, AX</code></span>
<span class="codeline" id="line-125"><code>	MOVQ	DX, BX</code></span>
<span class="codeline" id="line-126"><code>	// Calling ABIInternal because TLS might be nil.</code></span>
<span class="codeline" id="line-127"><code>	CALL	runtime·sigtrampgo&lt;ABIInternal&gt;(SB)</code></span>
<span class="codeline" id="line-128"><code>	// Return value is already stored in AX.</code></span>
<span class="codeline" id="line-129"><code></code></span>
<span class="codeline" id="line-130"><code>	ADJSP	$-16</code></span>
<span class="codeline" id="line-131"><code></code></span>
<span class="codeline" id="line-132"><code>	POP_REGS_HOST_TO_ABI0()</code></span>
<span class="codeline" id="line-133"><code>	RET</code></span>
<span class="codeline" id="line-134"><code></code></span>
<span class="codeline" id="line-135"><code>// Trampoline to resume execution from exception handler.</code></span>
<span class="codeline" id="line-136"><code>// This is part of the control flow guard workaround.</code></span>
<span class="codeline" id="line-137"><code>// It switches stacks and jumps to the continuation address.</code></span>
<span class="codeline" id="line-138"><code>// R8 and R9 are set above at the end of sigtrampgo</code></span>
<span class="codeline" id="line-139"><code>// in the context that starts executing at sigresume.</code></span>
<span class="codeline" id="line-140"><code>TEXT runtime·sigresume(SB),NOSPLIT|NOFRAME,$0</code></span>
<span class="codeline" id="line-141"><code>	MOVQ	R8, SP</code></span>
<span class="codeline" id="line-142"><code>	JMP	R9</code></span>
<span class="codeline" id="line-143"><code></code></span>
<span class="codeline" id="line-144"><code>TEXT runtime·exceptiontramp(SB),NOSPLIT|NOFRAME,$0</code></span>
<span class="codeline" id="line-145"><code>	// PExceptionPointers already on CX</code></span>
<span class="codeline" id="line-146"><code>	MOVQ	$const_callbackVEH, DX</code></span>
<span class="codeline" id="line-147"><code>	JMP	sigtramp&lt;&gt;(SB)</code></span>
<span class="codeline" id="line-148"><code></code></span>
<span class="codeline" id="line-149"><code>TEXT runtime·firstcontinuetramp(SB),NOSPLIT|NOFRAME,$0-0</code></span>
<span class="codeline" id="line-150"><code>	// PExceptionPointers already on CX</code></span>
<span class="codeline" id="line-151"><code>	MOVQ	$const_callbackFirstVCH, DX</code></span>
<span class="codeline" id="line-152"><code>	JMP	sigtramp&lt;&gt;(SB)</code></span>
<span class="codeline" id="line-153"><code></code></span>
<span class="codeline" id="line-154"><code>TEXT runtime·lastcontinuetramp(SB),NOSPLIT|NOFRAME,$0-0</code></span>
<span class="codeline" id="line-155"><code>	// PExceptionPointers already on CX</code></span>
<span class="codeline" id="line-156"><code>	MOVQ	$const_callbackLastVCH, DX</code></span>
<span class="codeline" id="line-157"><code>	JMP	sigtramp&lt;&gt;(SB)</code></span>
<span class="codeline" id="line-158"><code></code></span>
<span class="codeline" id="line-159"><code>TEXT runtime·sehtramp(SB),NOSPLIT,$40-0</code></span>
<span class="codeline" id="line-160"><code>	// CX: PEXCEPTION_RECORD ExceptionRecord</code></span>
<span class="codeline" id="line-161"><code>	// DX: ULONG64 EstablisherFrame</code></span>
<span class="codeline" id="line-162"><code>	// R8: PCONTEXT ContextRecord</code></span>
<span class="codeline" id="line-163"><code>	// R9: PDISPATCHER_CONTEXT DispatcherContext</code></span>
<span class="codeline" id="line-164"><code>	// Switch from the host ABI to the Go ABI.</code></span>
<span class="codeline" id="line-165"><code>	PUSH_REGS_HOST_TO_ABI0()</code></span>
<span class="codeline" id="line-166"><code></code></span>
<span class="codeline" id="line-167"><code>	get_tls(AX)</code></span>
<span class="codeline" id="line-168"><code>	CMPQ	AX, $0</code></span>
<span class="codeline" id="line-169"><code>	JNE	2(PC)</code></span>
<span class="codeline" id="line-170"><code>	// This shouldn't happen, sehtramp is only attached to functions</code></span>
<span class="codeline" id="line-171"><code>	// called from Go, and exception handlers are only called from</code></span>
<span class="codeline" id="line-172"><code>	// the thread that threw the exception.</code></span>
<span class="codeline" id="line-173"><code>	INT	$3</code></span>
<span class="codeline" id="line-174"><code></code></span>
<span class="codeline" id="line-175"><code>	// Exception from Go thread, set R14.</code></span>
<span class="codeline" id="line-176"><code>	MOVQ	g(AX), R14</code></span>
<span class="codeline" id="line-177"><code></code></span>
<span class="codeline" id="line-178"><code>	ADJSP	$40</code></span>
<span class="codeline" id="line-179"><code>	MOVQ	CX, 0(SP)</code></span>
<span class="codeline" id="line-180"><code>	MOVQ	DX, 8(SP)</code></span>
<span class="codeline" id="line-181"><code>	MOVQ	R8, 16(SP)</code></span>
<span class="codeline" id="line-182"><code>	MOVQ	R9, 24(SP)</code></span>
<span class="codeline" id="line-183"><code>	CALL	runtime·sehhandler(SB)</code></span>
<span class="codeline" id="line-184"><code>	MOVL	32(SP), AX</code></span>
<span class="codeline" id="line-185"><code></code></span>
<span class="codeline" id="line-186"><code>	ADJSP	$-40</code></span>
<span class="codeline" id="line-187"><code></code></span>
<span class="codeline" id="line-188"><code>	POP_REGS_HOST_TO_ABI0()</code></span>
<span class="codeline" id="line-189"><code>	RET</code></span>
<span class="codeline" id="line-190"><code></code></span>
<span class="codeline" id="line-191"><code>TEXT runtime·callbackasm1(SB),NOSPLIT|NOFRAME,$0</code></span>
<span class="codeline" id="line-192"><code>	// Construct args vector for cgocallback().</code></span>
<span class="codeline" id="line-193"><code>	// By windows/amd64 calling convention first 4 args are in CX, DX, R8, R9</code></span>
<span class="codeline" id="line-194"><code>	// args from the 5th on are on the stack.</code></span>
<span class="codeline" id="line-195"><code>	// In any case, even if function has 0,1,2,3,4 args, there is reserved</code></span>
<span class="codeline" id="line-196"><code>	// but uninitialized "shadow space" for the first 4 args.</code></span>
<span class="codeline" id="line-197"><code>	// The values are in registers.</code></span>
<span class="codeline" id="line-198"><code>	MOVQ	CX, (16+0)(SP)</code></span>
<span class="codeline" id="line-199"><code>	MOVQ	DX, (16+8)(SP)</code></span>
<span class="codeline" id="line-200"><code>	MOVQ	R8, (16+16)(SP)</code></span>
<span class="codeline" id="line-201"><code>	MOVQ	R9, (16+24)(SP)</code></span>
<span class="codeline" id="line-202"><code>	// R8 = address of args vector</code></span>
<span class="codeline" id="line-203"><code>	LEAQ	(16+0)(SP), R8</code></span>
<span class="codeline" id="line-204"><code></code></span>
<span class="codeline" id="line-205"><code>	// remove return address from stack, we are not returning to callbackasm, but to its caller.</code></span>
<span class="codeline" id="line-206"><code>	MOVQ	0(SP), AX</code></span>
<span class="codeline" id="line-207"><code>	ADDQ	$8, SP</code></span>
<span class="codeline" id="line-208"><code></code></span>
<span class="codeline" id="line-209"><code>	// determine index into runtime·cbs table</code></span>
<span class="codeline" id="line-210"><code>	MOVQ	$runtime·callbackasm(SB), DX</code></span>
<span class="codeline" id="line-211"><code>	SUBQ	DX, AX</code></span>
<span class="codeline" id="line-212"><code>	MOVQ	$0, DX</code></span>
<span class="codeline" id="line-213"><code>	MOVQ	$5, CX	// divide by 5 because each call instruction in runtime·callbacks is 5 bytes long</code></span>
<span class="codeline" id="line-214"><code>	DIVL	CX</code></span>
<span class="codeline" id="line-215"><code>	SUBQ	$1, AX	// subtract 1 because return PC is to the next slot</code></span>
<span class="codeline" id="line-216"><code></code></span>
<span class="codeline" id="line-217"><code>	// Switch from the host ABI to the Go ABI.</code></span>
<span class="codeline" id="line-218"><code>	PUSH_REGS_HOST_TO_ABI0()</code></span>
<span class="codeline" id="line-219"><code></code></span>
<span class="codeline" id="line-220"><code>	// Create a struct callbackArgs on our stack to be passed as</code></span>
<span class="codeline" id="line-221"><code>	// the "frame" to cgocallback and on to callbackWrap.</code></span>
<span class="codeline" id="line-222"><code>	SUBQ	$(24+callbackArgs__size), SP</code></span>
<span class="codeline" id="line-223"><code>	MOVQ	AX, (24+callbackArgs_index)(SP) 	// callback index</code></span>
<span class="codeline" id="line-224"><code>	MOVQ	R8, (24+callbackArgs_args)(SP)  	// address of args vector</code></span>
<span class="codeline" id="line-225"><code>	MOVQ	$0, (24+callbackArgs_result)(SP)	// result</code></span>
<span class="codeline" id="line-226"><code>	LEAQ	24(SP), AX</code></span>
<span class="codeline" id="line-227"><code>	// Call cgocallback, which will call callbackWrap(frame).</code></span>
<span class="codeline" id="line-228"><code>	MOVQ	$0, 16(SP)	// context</code></span>
<span class="codeline" id="line-229"><code>	MOVQ	AX, 8(SP)	// frame (address of callbackArgs)</code></span>
<span class="codeline" id="line-230"><code>	LEAQ	·callbackWrap&lt;ABIInternal&gt;(SB), BX	// cgocallback takes an ABIInternal entry-point</code></span>
<span class="codeline" id="line-231"><code>	MOVQ	BX, 0(SP)	// PC of function value to call (callbackWrap)</code></span>
<span class="codeline" id="line-232"><code>	CALL	·cgocallback(SB)</code></span>
<span class="codeline" id="line-233"><code>	// Get callback result.</code></span>
<span class="codeline" id="line-234"><code>	MOVQ	(24+callbackArgs_result)(SP), AX</code></span>
<span class="codeline" id="line-235"><code>	ADDQ	$(24+callbackArgs__size), SP</code></span>
<span class="codeline" id="line-236"><code></code></span>
<span class="codeline" id="line-237"><code>	POP_REGS_HOST_TO_ABI0()</code></span>
<span class="codeline" id="line-238"><code></code></span>
<span class="codeline" id="line-239"><code>	// The return value was placed in AX above.</code></span>
<span class="codeline" id="line-240"><code>	RET</code></span>
<span class="codeline" id="line-241"><code></code></span>
<span class="codeline" id="line-242"><code>// uint32 tstart_stdcall(M *newm);</code></span>
<span class="codeline" id="line-243"><code>TEXT runtime·tstart_stdcall(SB),NOSPLIT|NOFRAME,$0</code></span>
<span class="codeline" id="line-244"><code>	// Switch from the host ABI to the Go ABI.</code></span>
<span class="codeline" id="line-245"><code>	PUSH_REGS_HOST_TO_ABI0()</code></span>
<span class="codeline" id="line-246"><code></code></span>
<span class="codeline" id="line-247"><code>	// CX contains first arg newm</code></span>
<span class="codeline" id="line-248"><code>	MOVQ	m_g0(CX), DX		// g</code></span>
<span class="codeline" id="line-249"><code></code></span>
<span class="codeline" id="line-250"><code>	// Layout new m scheduler stack on os stack.</code></span>
<span class="codeline" id="line-251"><code>	MOVQ	SP, AX</code></span>
<span class="codeline" id="line-252"><code>	MOVQ	AX, (g_stack+stack_hi)(DX)</code></span>
<span class="codeline" id="line-253"><code>	SUBQ	$(64*1024), AX		// initial stack size (adjusted later)</code></span>
<span class="codeline" id="line-254"><code>	MOVQ	AX, (g_stack+stack_lo)(DX)</code></span>
<span class="codeline" id="line-255"><code>	ADDQ	$const_stackGuard, AX</code></span>
<span class="codeline" id="line-256"><code>	MOVQ	AX, g_stackguard0(DX)</code></span>
<span class="codeline" id="line-257"><code>	MOVQ	AX, g_stackguard1(DX)</code></span>
<span class="codeline" id="line-258"><code></code></span>
<span class="codeline" id="line-259"><code>	// Set up tls.</code></span>
<span class="codeline" id="line-260"><code>	LEAQ	m_tls(CX), DI</code></span>
<span class="codeline" id="line-261"><code>	MOVQ	CX, g_m(DX)</code></span>
<span class="codeline" id="line-262"><code>	MOVQ	DX, g(DI)</code></span>
<span class="codeline" id="line-263"><code>	CALL	runtime·settls(SB) // clobbers CX</code></span>
<span class="codeline" id="line-264"><code></code></span>
<span class="codeline" id="line-265"><code>	CALL	runtime·stackcheck(SB)	// clobbers AX,CX</code></span>
<span class="codeline" id="line-266"><code>	CALL	runtime·mstart(SB)</code></span>
<span class="codeline" id="line-267"><code></code></span>
<span class="codeline" id="line-268"><code>	POP_REGS_HOST_TO_ABI0()</code></span>
<span class="codeline" id="line-269"><code></code></span>
<span class="codeline" id="line-270"><code>	XORL	AX, AX			// return 0 == success</code></span>
<span class="codeline" id="line-271"><code>	RET</code></span>
<span class="codeline" id="line-272"><code></code></span>
<span class="codeline" id="line-273"><code>// set tls base to DI</code></span>
<span class="codeline" id="line-274"><code>TEXT runtime·settls(SB),NOSPLIT,$0</code></span>
<span class="codeline" id="line-275"><code>	MOVQ	runtime·tls_g(SB), CX</code></span>
<span class="codeline" id="line-276"><code>	MOVQ	DI, 0(CX)(GS)</code></span>
<span class="codeline" id="line-277"><code>	RET</code></span>
<span class="codeline" id="line-278"><code></code></span>
<span class="codeline" id="line-279"><code>TEXT runtime·nanotime1(SB),NOSPLIT,$0-8</code></span>
<span class="codeline" id="line-280"><code>	MOVQ	$_INTERRUPT_TIME, DI</code></span>
<span class="codeline" id="line-281"><code>	MOVQ	time_lo(DI), AX</code></span>
<span class="codeline" id="line-282"><code>	IMULQ	$100, AX</code></span>
<span class="codeline" id="line-283"><code>	MOVQ	AX, ret+0(FP)</code></span>
<span class="codeline" id="line-284"><code>	RET</code></span>
<span class="codeline" id="line-285"><code></code></span>
<span class="codeline" id="line-286"><code>// func osSetupTLS(mp *m)</code></span>
<span class="codeline" id="line-287"><code>// Setup TLS. for use by needm on Windows.</code></span>
<span class="codeline" id="line-288"><code>TEXT runtime·osSetupTLS(SB),NOSPLIT,$0-8</code></span>
<span class="codeline" id="line-289"><code>	MOVQ	mp+0(FP), AX</code></span>
<span class="codeline" id="line-290"><code>	LEAQ	m_tls(AX), DI</code></span>
<span class="codeline" id="line-291"><code>	CALL	runtime·settls(SB)</code></span>
<span class="codeline" id="line-292"><code>	RET</code></span>
<span class="codeline" id="line-293"><code></code></span>
<span class="codeline" id="line-294"><code>// This is called from rt0_go, which runs on the system stack</code></span>
<span class="codeline" id="line-295"><code>// using the initial stack allocated by the OS.</code></span>
<span class="codeline" id="line-296"><code>TEXT runtime·wintls(SB),NOSPLIT,$0</code></span>
<span class="codeline" id="line-297"><code>	// Allocate a TLS slot to hold g across calls to external code</code></span>
<span class="codeline" id="line-298"><code>	MOVQ	SP, AX</code></span>
<span class="codeline" id="line-299"><code>	ANDQ	$~15, SP	// alignment as per Windows requirement</code></span>
<span class="codeline" id="line-300"><code>	SUBQ	$48, SP	// room for SP and 4 args as per Windows requirement</code></span>
<span class="codeline" id="line-301"><code>			// plus one extra word to keep stack 16 bytes aligned</code></span>
<span class="codeline" id="line-302"><code>	MOVQ	AX, 32(SP)</code></span>
<span class="codeline" id="line-303"><code>	MOVQ	runtime·_TlsAlloc(SB), AX</code></span>
<span class="codeline" id="line-304"><code>	CALL	AX</code></span>
<span class="codeline" id="line-305"><code>	MOVQ	32(SP), SP</code></span>
<span class="codeline" id="line-306"><code></code></span>
<span class="codeline" id="line-307"><code>	MOVQ	AX, CX	// TLS index</code></span>
<span class="codeline" id="line-308"><code></code></span>
<span class="codeline" id="line-309"><code>	// Assert that slot is less than 64 so we can use _TEB-&gt;TlsSlots</code></span>
<span class="codeline" id="line-310"><code>	CMPQ	CX, $64</code></span>
<span class="codeline" id="line-311"><code>	JB	ok</code></span>
<span class="codeline" id="line-312"><code></code></span>
<span class="codeline" id="line-313"><code>	// Fallback to the TEB arbitrary pointer.</code></span>
<span class="codeline" id="line-314"><code>	// TODO: don't use the arbitrary pointer (see go.dev/issue/59824)</code></span>
<span class="codeline" id="line-315"><code>	MOVQ	$TEB_ArbitraryPtr, CX</code></span>
<span class="codeline" id="line-316"><code>	JMP	settls</code></span>
<span class="codeline" id="line-317"><code>ok:</code></span>
<span class="codeline" id="line-318"><code>	// Convert the TLS index at CX into</code></span>
<span class="codeline" id="line-319"><code>	// an offset from TEB_TlsSlots.</code></span>
<span class="codeline" id="line-320"><code>	SHLQ	$3, CX</code></span>
<span class="codeline" id="line-321"><code></code></span>
<span class="codeline" id="line-322"><code>	// Save offset from TLS into tls_g.</code></span>
<span class="codeline" id="line-323"><code>	ADDQ	$TEB_TlsSlots, CX</code></span>
<span class="codeline" id="line-324"><code>settls:</code></span>
<span class="codeline" id="line-325"><code>	MOVQ	CX, runtime·tls_g(SB)</code></span>
<span class="codeline" id="line-326"><code>	RET</code></span>
</pre><pre id="footer">
<table><tr><td><img src="../../png/zigo101-twitter.png"></td>
<td>The pages are generated with <a href="https://go101.org/apps-and-libs/golds.html"><b>Golds</b></a> <i>v0.7.5</i>. (GOOS=windows GOARCH=amd64)
<b>Golds</b> is a <a href="https://go101.org">Go 101</a> project developed by <a href="https://tapirgames.com">Tapir Liu</a>.
PR and bug reports are welcome and can be submitted to <a href="https://github.com/go101/golds">the issue list</a>.
Please follow <a href="https://twitter.com/zigo_101">@zigo_101</a> (reachable from the left QR code) to get the latest news of <b>Golds</b>.</td></tr></table></pre>